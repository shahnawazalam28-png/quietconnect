<!DOCTYPE html>
<html>
<head>
  <title>QuietConnect</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #e9f1f7;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background: white;
      width: 500px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      text-align: center;
    }

    video {
      width: 220px;
      height: 160px;
      background: black;
      border-radius: 8px;
      margin: 5px;
    }

    #videos {
      display: none;
      justify-content: center;
    }

    #chat {
      display: none;
    }

    #messages {
      height: 120px;
      overflow-y: auto;
      background: #f7f9fc;
      border-radius: 8px;
      padding: 8px;
      margin: 10px 0;
      text-align: left;
    }

    input { padding: 8px; margin: 5px; width: 80%; }
    button { padding: 8px 15px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>

<div class="card">

  <div id="consent">
    <h2>QuietConnect ðŸŒ¿ðŸŒ´</h2>
    <p>Video space for shy adults (18+)</p>
    <input id="username" placeholder="Your name" />
    <input id="location" placeholder="Your location" />
    <button onclick="start()">Enter</button>
  </div>

  <div id="chat">
    <h3 id="status">Waiting...</h3>
<div id="videos" style="display:none;">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>
    <div id="videos">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="messages"></div>

    <input id="input" placeholder="Type message..." />
    <button onclick="send()">Send</button>
    <button onclick="skip()">Skip</button>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let localStream;
let peerConnection;

const servers = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

const consent = document.getElementById("consent");
const chat = document.getElementById("chat");
const status = document.getElementById("status");
const messages = document.getElementById("messages");

let myName = "";
let myLocation = "";

function start() {
  const nameInput = document.getElementById("username").value.trim();
  const locationInput = document.getElementById("location").value.trim();
  const acknowledge = document.getElementById("acknowledge").checked;

  if (!acknowledge) {
    alert("Please confirm the acknowledgement before entering.");
    return;
  }

  if (!nameInput || !locationInput) {
    alert("Please enter your name and location.");
    return;
  }

  myName = nameInput;
  myLocation = locationInput;

  consent.style.display = "none";
  chat.style.display = "block";

  socket.emit("userInfo", { name: myName, location: myLocation });
}

function createPeer() {
  peerConnection = new RTCPeerConnection(servers);

  localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
  });

  peerConnection.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = event => {
    if (event.candidate) {
      socket.emit("ice-candidate", event.candidate);
    }
  };
}

socket.on("connected", async (data) => {
  status.innerText = "Connected with " + data.partnerName;

  // Start camera ONLY after match
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  document.getElementById("localVideo").srcObject = localStream;
  document.getElementById("videos").style.display = "flex";

  createPeer();

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  socket.emit("offer", offer);
});

socket.on("offer", async offer => {
  createPeer();
  await peerConnection.setRemoteDescription(offer);

  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit("answer", answer);
});

socket.on("answer", async answer => {
  await peerConnection.setRemoteDescription(answer);
});

socket.on("ice-candidate", async candidate => {
  if (peerConnection) {
    await peerConnection.addIceCandidate(candidate);
  }
});

socket.on("partnerDisconnected", () => {
  location.reload();
});
</script>

</body>
</html>