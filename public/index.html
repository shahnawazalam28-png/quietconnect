<!DOCTYPE html>
<html>
<head>
  <title>QuietConnect</title>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
    <text y='70' font-size='70'>ðŸŒ¿ðŸŒ´</text>
  </svg>">

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #e9f1f7;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background: white;
      width: 520px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      text-align: center;
    }

    h2 { margin: 10px 0; }

    .disclaimer {
      font-size: 13px;
      text-align: left;
      line-height: 1.6;
      color: #444;
      margin-bottom: 10px;
    }

    input {
      width: 90%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      padding: 8px 14px;
      margin: 5px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .primary { background: #4a90e2; color: white; }
    .secondary { background: #ddd; }

    #chat { display: none; }

    #videos {
      display: none;
      justify-content: center;
      margin: 10px 0;
    }

    video {
      width: 220px;
      height: 160px;
      background: black;
      border-radius: 8px;
      margin: 5px;
    }

    #messages {
      height: 120px;
      overflow-y: auto;
      background: #f7f9fc;
      border-radius: 8px;
      padding: 8px;
      text-align: left;
      margin: 10px 0;
      font-size: 14px;
    }

    #status {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

  </style>
</head>

<body>

<div class="card">

  <!-- ENTRY SCREEN -->
  <div id="consent">
    <h2>ðŸŒ¿ QuietConnect ðŸŒ´</h2>

    <div class="disclaimer">
      The world is filled with different personalities.  
      Many people are naturally shy or experience social anxiety.  
      For some, starting conversations or meeting new people can feel overwhelming.
      <br><br>
      QuietConnect is a calm and respectful space created for adults (18+) 
      who want to take a small, brave step forward.  
      Here, you can talk to someone from a different background â€” 
      someone who, like you, also wants to grow.
      <br><br>
      Start simply by sharing your name and where you're from.  
      You may skip anytime if you feel uncomfortable.
    </div>

    <label style="font-size:13px;">
      <input type="checkbox" id="acknowledge">
      I confirm that I am 18+ and I am choosing to take a positive step forward.
    </label>

    <br>

    <input id="username" placeholder="Your name">
    <input id="location" placeholder="Your location">

    <button class="primary" onclick="start()">Enter QuietConnect</button>
  </div>

  <!-- CHAT + VIDEO SCREEN -->
  <div id="chat">
    <h2>ðŸŒ¿ QuietConnect ðŸŒ´</h2>

    <div id="status">Waiting for partner...</div>

    <div id="videos">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="messages"></div>

    <input id="input" placeholder="Type message...">
    <button class="primary" onclick="send()">Send</button>
    <button class="secondary" onclick="skip()">Skip</button>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let localStream;
let peerConnection;
let isCaller = false;

const servers = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

const consent = document.getElementById("consent");
const chat = document.getElementById("chat");
const status = document.getElementById("status");
const messages = document.getElementById("messages");

function start() {
  const name = document.getElementById("username").value.trim();
  const location = document.getElementById("location").value.trim();
  const ack = document.getElementById("acknowledge").checked;

  if (!ack) {
    alert("Please confirm acknowledgement.");
    return;
  }

  if (!name || !location) {
    alert("Please enter name and location.");
    return;
  }

  consent.style.display = "none";
  chat.style.display = "block";

  socket.emit("userInfo", { name, location });
}

async function initMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  document.getElementById("localVideo").srcObject = localStream;
  document.getElementById("videos").style.display = "flex";
}

function createPeer() {
  peerConnection = new RTCPeerConnection(servers);

  localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
  });

  peerConnection.ontrack = (event) => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
  };

  peerConnection.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("ice-candidate", event.candidate);
    }
  };
}

socket.on("connected", async (data) => {
  status.innerText = "Connected with " + data.partnerName + " from " + data.partnerLocation;

  await initMedia();
  createPeer();

  // First user becomes caller
  isCaller = true;

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  socket.emit("offer", offer);
});

socket.on("offer", async (offer) => {
  await initMedia();
  createPeer();

  await peerConnection.setRemoteDescription(offer);
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit("answer", answer);
});

socket.on("answer", async (answer) => {
  await peerConnection.setRemoteDescription(answer);
});

socket.on("ice-candidate", async (candidate) => {
  if (peerConnection) {
    await peerConnection.addIceCandidate(candidate);
  }
});

socket.on("message", (msg) => {
  messages.innerHTML += "<div>Stranger: " + msg + "</div>";
});

socket.on("partnerDisconnected", () => {
  location.reload();
});

function send() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  socket.emit("message", text);
  messages.innerHTML += "<div>You: " + text + "</div>";
  input.value = "";
}

function skip() {
  location.reload();
}
</script>

</body>
</html>