<!DOCTYPE html>
<html>
<head>
  <title>QuietConnect</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #e9f1f7;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background: white;
      width: 520px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      text-align: center;
    }

    h2 { margin: 10px 0; }

    .disclaimer {
      font-size: 13px;
      text-align: left;
      line-height: 1.6;
      color: #444;
      margin-bottom: 10px;
    }

    input {
      width: 90%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      padding: 8px 14px;
      margin: 5px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .primary { background: #4a90e2; color: white; }
    .secondary { background: #ddd; }

    #chat { display: none; }

    #videos {
      display: none;
      justify-content: center;
      margin: 10px 0;
    }

    video {
      width: 220px;
      height: 160px;
      background: black;
      border-radius: 8px;
      margin: 5px;
    }

    #messages {
      height: 120px;
      overflow-y: auto;
      background: #f7f9fc;
      border-radius: 8px;
      padding: 8px;
      text-align: left;
      margin: 10px 0;
      font-size: 14px;
    }

    #status {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

    .support-text {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="card">

  <!-- ENTRY SCREEN -->
  <div id="consent">
    <h2>üåø QuietConnect üå¥</h2>

    <div class="disclaimer">
      Many people are naturally shy or experience social anxiety.
      QuietConnect is a respectful space for adults (18+) who want
      to take a small step forward and connect with someone new.
      You may skip anytime.
    </div>

    <label style="font-size:13px;">
      <input type="checkbox" id="acknowledge">
      I confirm I am 18+ and choosing to take a positive step forward.
    </label>

    <input id="username" placeholder="Your name">
    <input id="location" placeholder="Your location">

    <button class="primary" onclick="start()">Enter</button>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chat">
    <h2>üåø QuietConnect üå¥</h2>
    <div id="status">Waiting for partner...</div>

    <div id="videos">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="messages"></div>

    <input id="input" placeholder="Type message...">
    <button class="primary" onclick="send()">Send</button>
    <button class="secondary" onclick="skip()">Skip</button>

    <div class="support-text">
      If this space helped you, you may support it üåø
    </div>

    <a href="https://buymeacoffee.com/shyconnect" target="_blank">
      <button class="secondary">üíù Support QuietConnect</button>
    </a>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let localStream;
let pc;
let isPolite = false;
let makingOffer = false;
let ignoreOffer = false;

const servers = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    {
      urls: "turn:openrelay.metered.ca:80",
      username: "openrelayproject",
      credential: "openrelayproject"
    }
  ]
};

function start() {
  const name = document.getElementById("username").value.trim();
  const location = document.getElementById("location").value.trim();
  const ack = document.getElementById("acknowledge").checked;

  if (!ack) return alert("Please confirm acknowledgement.");
  if (!name || !location) return alert("Enter name and location.");

  document.getElementById("consent").style.display = "none";
  document.getElementById("chat").style.display = "block";

  socket.emit("userInfo", { name, location });
}

async function initMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  document.getElementById("localVideo").srcObject = localStream;
  document.getElementById("videos").style.display = "flex";
}

function createPeer() {
  pc = new RTCPeerConnection(servers);

  localStream.getTracks().forEach(track =>
    pc.addTrack(track, localStream)
  );

  pc.ontrack = (event) => {
    const remoteVideo = document.getElementById("remoteVideo");
    remoteVideo.srcObject = event.streams[0];
    remoteVideo.play().catch(()=>{});
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("ice-candidate", event.candidate);
    }
  };

  pc.onnegotiationneeded = async () => {
    try {
      makingOffer = true;
      await pc.setLocalDescription(await pc.createOffer());
      socket.emit("offer", pc.localDescription);
    } finally {
      makingOffer = false;
    }
  };
}

socket.on("connected", async (data) => {
  document.getElementById("status").innerText =
    "Connected with " + data.partnerName;

  isPolite = !data.isCaller;

  await initMedia();
  createPeer();
});

socket.on("offer", async (offer) => {
  const offerCollision =
    makingOffer || pc.signalingState !== "stable";

  ignoreOffer = !isPolite && offerCollision;
  if (ignoreOffer) return;

  await pc.setRemoteDescription(offer);
  await pc.setLocalDescription(await pc.createAnswer());
  socket.emit("answer", pc.localDescription);
});

socket.on("answer", async (answer) => {
  await pc.setRemoteDescription(answer);
});

socket.on("ice-candidate", async (candidate) => {
  try {
    await pc.addIceCandidate(candidate);
  } catch (err) {
    if (!ignoreOffer) console.error(err);
  }
});

socket.on("partnerDisconnected", () => {
  cleanup();
});

function cleanup() {
  if (pc) pc.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());

  document.getElementById("videos").style.display = "none";
  document.getElementById("remoteVideo").srcObject = null;
  document.getElementById("localVideo").srcObject = null;
  document.getElementById("messages").innerHTML = "";
  document.getElementById("status").innerText = "Looking for new partner...";
}

function skip() {
  cleanup();
  socket.emit("skip");
}

function send() {
  const input = document.getElementById("input");
  if (!input.value.trim()) return;
  socket.emit("message", input.value);
  document.getElementById("messages").innerHTML += "<div>You: " + input.value + "</div>";
  input.value = "";
}
</script>

</body>
</html>